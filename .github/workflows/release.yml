name: Build and Release Python exe

on:
  push:
    tags:
      - 'v*'  # 当推送标签时运行

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Check out source code
      uses: actions/checkout@v3

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller  # 使用 pyinstaller 进行 py -> exe

    - name: Build Python script to exe
      run: pyinstaller --onefile convert.py

    - name: Download ffmpeg and ffprobe
      run: |
        # 下载 ffmpeg 和 ffprobe 的 Windows 版本，并解压
        curl -L https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip -o ffmpeg.zip
        tar -xf ffmpeg.zip --strip-components=1 --wildcards --no-anchored '*.exe' -C .  # 解压到当前目录
      shell: bash

    - name: Prepare for release (zip the package)
      run: |
        mkdir release
        mv dist/convert.exe release/  # 将主程序移动到 release 目录
        mv ffmpeg.exe release/    # 将 ffmpeg.exe 移动到 release 目录
        mv ffprobe.exe release/   # 将 ffprobe.exe 移动到 release 目录
        cd release
        zip -r ../convert.zip .  # 压缩所有内容到 convert.zip

    - name: Upload Release to GitHub
      uses: softprops/action-gh-release@v1
      with:
        files: convert.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
