name: Build and Release Python exe

on:
  push:
    tags:
      - 'v*' # 当推送标签时运行

jobs:
  build:
    # 使用 Ubuntu 系统运行 Actions
    runs-on: ubuntu-latest

    steps:
    - name: Check out source code
      uses: actions/checkout@v3

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Wine and prerequisites
      run: |
        sudo apt-get update
        sudo apt-get install -y wine-stable wine32 p7zip-full

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller  # 使用 pyinstaller 进行 py -> exe

    - name: Build Python script to Windows exe
      # 使用 Wine 运行 PyInstaller 并生成 Windows 的可执行文件
      run: |
        WINEARCH=win32 WINEPREFIX=/tmp/wine32 wine cmd.exe /c echo "Windows environment preparation complete"
        WINEARCH=win32 WINEPREFIX=/tmp/wine32 wine python -m pip install pyinstaller
        WINEARCH=win32 WINEPREFIX=/tmp/wine32 wine pyinstaller --onefile convert.py

    - name: Download FFmpeg and FFprobe binaries for Windows
      run: |
        # 下载 FFmpeg 和 FFprobe 的 Windows 预编译版本
        wget -O ffmpeg.zip https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip
        
        # 解压 FFmpeg 文件
        mkdir ffmpeg
        unzip ffmpeg.zip -d ffmpeg
        
        # 移动文件到当前工作目录
        mv ffmpeg/**/ffmpeg.exe .
        mv ffmpeg/**/ffprobe.exe .

    - name: Prepare for release (zip the package)
      run: |
        mkdir release
        mv dist/convert.exe release/          # 移动编译后的主程序到 release 目录
        mv ffmpeg.exe release/               # 移动 ffmpeg.exe 到 release
        mv ffprobe.exe release/              # 移动 ffprobe.exe 到 release
        cd release
        7z a -tzip ../convert.zip *          # 通过 7zip 工具，压缩为 convert.zip

    - name: Upload Release to GitHub
      uses: softprops/action-gh-release@v1
      with:
        files: convert.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
